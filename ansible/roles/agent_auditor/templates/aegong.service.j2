[Unit]
Description=Aegong Agent Auditor Service
After=network.target
Requires=nginx.service

[Service]
Type=simple
User=root
Group=root
WorkingDirectory={{ app_dir }}
ExecStart={{ app_dir }}/{{ binary_name }}
Restart=on-failure
RestartSec=10
Environment="PATH={{ app_dir }}/venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
Environment="HOST=127.0.0.1"
Environment="PORT={{ app_port }}"

{% if voice_enabled %}
Environment="{{ voice_key_pass_env_var }}={{ vault_aegong_key_pass }}"
{% endif %}

# Add capabilities for cgroup management
AmbientCapabilities=CAP_SYS_ADMIN CAP_SYS_RESOURCE
CapabilityBoundingSet=CAP_SYS_ADMIN CAP_SYS_RESOURCE

# Allow cgroup access
DeviceAllow=/dev/null rw
DeviceAllow=/dev/zero r
DeviceAllow=/dev/full w
DeviceAllow=/dev/random r
DeviceAllow=/dev/urandom r

# Ensure we can write to cgroups
ReadWritePaths=/sys/fs/cgroup

[Install]
WantedBy=multi-user.target

